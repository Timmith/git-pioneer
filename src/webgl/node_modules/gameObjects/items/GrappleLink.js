var three = require('three');
var cannon = require('cannon');
var CheckerboardTexture = require('threejs-texture-checkerboard');

require('extensions/threeCannon');

function GrappleLink(world, bodyA, bodyB, opts) {
	opts = opts || {};
	opts.restLength = 0;

	var spring = new cannon.Spring(bodyA, bodyB, opts);

	var geom = new three.SphereGeometry(0.5, 16, 8);
	var t = 0;
	geom.vertices.forEach(v => {
		v.y += 0.5;
		t = v.z;
		v.z = v.y;
		v.y = t;
	});
	var mat = new three.MeshBasicMaterial({
		wireframe: true
	});

	var mesh = new three.Mesh(geom, mat);
	world.scene.add(mesh);

	this.spring = spring;
	this.mesh = mesh;
	
	this.onCannonPostStep = onCannonPostStep.bind(this);
	this.onEnterFrame = onEnterFrame.bind(this);
	world.world.addEventListener("postStep", this.onCannonPostStep);	//TODO clean this up when removed from world
}

function onCannonPostStep(event) {
	this.spring.applyForce();
}

function onEnterFrame() {
	var mesh = this.mesh;
	var spring = this.spring;
	mesh.position.copy(spring.bodyA.pointToWorldFrame(spring.localAnchorA));
	var target = spring.bodyB.pointToWorldFrame(spring.localAnchorB).toThree();
	mesh.lookAt(target);
	var stretch = mesh.position.clone().sub(target).length();
	var squash = Math.min(1, 1 / stretch);
	mesh.scale.set(squash, squash, stretch);
}

module.exports = GrappleLink;